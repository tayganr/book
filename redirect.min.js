function Chooser(r,o){this.readerPreference="flash",this.pageNumber=-1,this.prependPath="",this.hasFlashUrl=!0,this.urls={},this.originalQuery={},this.origin="web",this.init=function(){null!=r&&(this.pageNumber=r),null!=o&&(this.readerPreference=o);for(var i=window.location.search.substr(1).split("&"),e=0;e<i.length;e++){var t=i[e].split("=",2);0<t[0].length&&(1<t.length?this.originalQuery[this.decodeFromQuery(t[0])]=this.decodeFromQuery(t[1]):this.originalQuery[this.decodeFromQuery(t[0])]="")}},this.getPageNumber=function(){if(0<=this.pageNumber)return this.pageNumber;if("page"in this.originalQuery)return this.originalQuery.page;var i=window.location.pathname,e=i.lastIndexOf("/")+1;if(0<e&&(i=i.substr(e).match(/^[^\d]+(?=\.)/))instanceof Array){var t=parseInt(i[0]);if(!isNaN(t))return t}return-1},this.redirect=function(){var i="#noRedirect";if("web"!=this.origin){var e=window.location.toString();if(e.length>i.length&&e.substr(e.length-i.length)==i)return}this.report=this.checkHTMLCompatibility(),"html"==this.origin?this.getUrls():this.performRedirect()},this.performRedirect=function(){var i="html"!=this.origin||this.hasFlashUrl;"html"==this.readerPreference?this.report.ok?this.goToHtmlReader():i&&this.supportsFlash()?this.goToFlashReader():this.incompatible():i&&this.supportsFlash()?this.isTablet()&&this.report.ok?this.goToHtmlReader():this.goToFlashReader():this.report.ok?this.goToHtmlReader():this.incompatible()},this.checkHTMLCompatibility=function(){var i=[],e={ok:!0,unsupportedFeatures:[]};for(var t in Modernizr)"boolean"!=typeof Modernizr[t]||Modernizr[t]||i.push(t);return 0<i.length&&(e.ok=!1,e.unsupportedFeatures=i),e},this.incompatible=function(){var i="?uF="+window.encodeURIComponent(this.report.unsupportedFeatures.join());window.open("incompatible.html"+i,"_self")},this.goToFlashReader=function(){if("webFlash"!=this.origin){var i,e=this.getPageNumber();"html"==this.origin?i=this.urls.flash:(i="flash/resources/"+(0<=e?e:"index")+".htm","webHtml"==this.origin&&(i="../"+i,"page"in this.originalQuery&&delete this.originalQuery.page)),this.goto(i)}},this.goToHtmlReader=function(){var i,e=this.getPageNumber();"webHtml"!=this.origin?(0<=e&&(this.originalQuery.page=e),"html"==this.origin?i=this.urls.html:(i="html/index.html","webFlash"==this.origin&&(i="../../"+i)),this.goto(i)):0<=e&&!("page"in this.originalQuery)&&history.pushState({},"",window.location.pathname+"?"+this.serialiseForQuery(this.originalQuery)+window.location.hash)},this.goto=function(i){var e=window.encodeURIComponent(window.document.referrer);e&&(this.originalQuery.refUrl=e);var t=i;"html"!=this.origin&&(t=this.prependPath+t);var r=this.serialiseForQuery(this.originalQuery);0<r.length&&(t+="?"+r),window.location.replace(t)},this.isTablet=function(){return this.hasMultiTouch()},this.supportsFlash=function(){var i="application/x-shockwave-flash",e=!1;if(null!=window.navigator.plugins["Shockwave Flash"]||window.navigator.plugins&&0<window.navigator.plugins.length&&window.navigator.mimeTypes&&window.navigator.mimeTypes[i]&&window.navigator.mimeTypes[i].enabledPlugin)e=!0;else try{new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash")&&(e=!0)}catch(i){}return e&&swfobject().hasFlashPlayerVersion("10")},this.hasMultiTouch=function(){return"ontouchstart"in window||window.navigator.pointerEnabled&&1<window.navigator.maxTouchPoints||window.navigator.msPointerEnabled&&1<window.navigator.msMaxTouchPoints||window.DocumentTouch&&window.document instanceof window.DocumentTouch},this.getUrls=function(){if("undefined"!=typeof bookId){$.ajax({url:"http://htmlreader.yudu.com/Yudu/jsonServices/getWebURLs?bookId="+bookId,context:this,success:this.urlResponderSuccess,error:this.urlResponder})}else this.urlResponder()},this.urlResponderSuccess=function(i){i&&(this.urls=i),this.urlResponder()},this.urlResponder=function(){this.urls.flash||(this.hasFlashUrl=!1),this.urls.html||(this.urls.html="reader.html"),this.performRedirect()},this.decodeFromQuery=function(i){return decodeURIComponent(i.replace(/\+/g," "))},this.serialiseForQuery=function(i){var e=[];for(var t in i)i.hasOwnProperty(t)&&e.push(encodeURIComponent(t)+"="+encodeURIComponent(i[t]));return e.join("&")},this.init()}