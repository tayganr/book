var controls=$("#controls"),buttons={},buttonCallbacks={},visibleButtons={__yudu_count:0},numberOfProductsSpan,toolbarInit=function(){registerForYuduEvents();createBar();initSharing();initContents();initUserPreferences();yudu_commonFunctions.toolbarFinishedLoading()},registerForYuduEvents=function(){yudu_events.subscribe(yudu_events.ALL,yudu_events.TOOLBAR.FIT_WIDTH_OR_SCREEN_ACTION,fitWidthOrScreenAction,!1);yudu_events.subscribe(yudu_events.ALL,yudu_events.TOOLBAR.UPDATE_SHOPPING_CART_BUTTON,handleShoppingCartEvent,
!1);yudu_events.subscribe(yudu_events.ALL,yudu_events.TOOLBAR.UPDATE_BOOKMARK_BUTTON,handleBookmarkUpdateEvent,!1);yudu_events.subscribe(yudu_events.ALL,yudu_events.COMMON.RESIZE,onResize,!1);yudu_events.subscribe(yudu_events.ALL,yudu_events.COMMON.TOUCH,hideTogglables,!1);yudu_events.subscribe(yudu_events.ALL,yudu_events.COMMON.LOGIN_APPROVED,onLoginApproved,!1);window.yudu_searchFunctions?searchSetup():yudu_events.subscribe(yudu_events.ALL,yudu_events.TOOLBAR.SEARCH_READY,searchSetup,!1)},fitWidthOrScreenAction=
function(a){a.data.fitOnlyWidth?visibleButtons.hasOwnProperty("fitPage")||(buttons.fitPage.css({left:buttons.fitWidth.css("left")}),hideButton("fitWidth"),showButton("fitPage")):visibleButtons.hasOwnProperty("fitWidth")||(buttons.fitWidth.css({left:buttons.fitPage.css("left")}),hideButton("fitPage"),showButton("fitWidth"))},handleShoppingCartEvent=function(a){var b=buttons.shoppingCart;if(a.data.toggleIcon){var c=yudu_toolbarSettings.shouldUseHighRes,d=getIconFor("shoppingCart",c);0<=b.css("background-image").indexOf(d.substr(1))?
(c=getIconFor("highlightedShoppingCart",c),b.css("background-image","url("+c+")")):b.css("background-image","url("+d+")")}a=a.data.numberOfProducts;null==a||0>=a?numberOfProductsSpan.html(""):100>a?numberOfProductsSpan.html(a):numberOfProductsSpan.html("99+")},handleBookmarkUpdateEvent=function(a){var b=buttons.bookmark;a=getIconFor(a.data.bookmarkOn?"bookmarked":"bookmark");b.css("background-image","url("+a+")")},createBar=function(){yudu_commonSettings.isDesktop?(yudu_toolbarSettings.logoSrc&&showLogo(),
yudu_toolbarSettings.searchEnabled&&showSearchBar()):controls.addClass("touchDevice");createButtons();addButtonListener()},showLogo=function(){var a=$("\x3cimg\x3e");a.attr("src",yudu_toolbarSettings.logoSrc);a.attr("id","logoImage");var b=$("#logoLink");b.append(a);yudu_toolbarSettings.logoLinkUrlExists&&b.click(yudu_toolbarFunctions.logoClicked);b.show()},showSearchBar=function(){$("#desktopSearchContainer").css("display","inline-block");var a=getIconFor("search");$("#desktopSearchGo").css("background-image",
"url("+a+")")},createButtons=function(){var a=yudu_toolbarSettings.shouldUseHighRes;yudu_toolbarSettings.editionListEnabled&&createButton("editionList",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.editionListClicked),a);yudu_toolbarSettings.hasArticles&&createButton("phoneview",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.openPhoneView),a);yudu_toolbarSettings.fullscreenModeEnabled&&initFullscreen(a);createButton("zoomIn",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.zoomInClicked),
a);createButton("zoomOut",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.zoomOutClicked),a);createButton("prevPage",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.prevPageClicked),a);createButton("nextPage",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.nextPageClicked),a);yudu_toolbarSettings.pageModeStopToggle||createButton("twoUpToggle",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.twoUpToggleClicked),a);createButton("fitWidth",buttonOtherThanTogglableHit(this,
yudu_toolbarFunctions.fitWidthClicked),a);createButton("fitPage",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.fitPageClicked),a);createButton("thumbnailToggle",toggleThumbnailsAction,a);yudu_contentsSettings.contentsData&&0<yudu_contentsSettings.contentsData.length&&createButton("contents",toggleContentsAction,a);(yudu_toolbarSettings.sharing.emailEnabled||yudu_toolbarSettings.sharing.twitter||yudu_toolbarSettings.sharing.facebook)&&createButton("share",toggleShareAction,a);yudu_toolbarSettings.hasDownloadablePdfAndIsNotApp&&
createButton("downloadPdf",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.downloadPdfClicked),a);yudu_toolbarSettings.searchEnabled&&!yudu_commonSettings.isDesktop&&createButton("search",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.searchClicked),a);yudu_toolbarSettings.bookmarksEnabled&&createButton("bookmark",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.bookmarkClicked),a);yudu_toolbarSettings.notesEnabled&&createButton("note",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.notesClicked),
a);yudu_toolbarSettings.highlightsEnabled&&createButton("highlight",toggleDrawingModeAction,a);yudu_toolbarSettings.orderFormEnabled&&(numberOfProductsSpan=$(document.createElement("span")),numberOfProductsSpan.css("position","absolute"),numberOfProductsSpan.css("bottom","0px"),numberOfProductsSpan.css("margin-left","22px"),numberOfProductsSpan.css("margin-bottom",(yudu_commonSettings.isDesktop?"4":"-4")+"px"),numberOfProductsSpan.css("font-size","10px"),createButton("shoppingCart",buttonOtherThanTogglableHit(this,
yudu_toolbarFunctions.shoppingCartClicked),a),buttons.shoppingCart.append(numberOfProductsSpan));yudu_toolbarSettings.editionLaunchableHtmlEnabled&&createButton("editionLaunchableHtml",buttonOtherThanTogglableHit(this,yudu_toolbarFunctions.editionLaunchableHtmlClicked,a));yudu_toolbarSettings.userPreferences&&enableUserPreferencesSettings()&&createButton("userPreferences",toggleUserPreferencesAction,a);yudu_toolbarFunctions.articlesAvailable()||hideButton("phoneview");hideButton("fitPage");yudu_commonSettings.isDesktop||
(hideButton("prevPage"),hideButton("nextPage"),hideButton("zoomIn"),hideButton("zoomOut"),480>=yudu_commonSettings.width&&hideButton("twoUpToggle"),positionButtonsForTouch())},createButton=function(a,b,c){c=getIconFor(a,c);var d=$('\x3ca type\x3d"button" class\x3d"control" tabindex\x3d"-1" id\x3d"'+a+'"\x3e\x3c/a\x3e');yudu_commonSettings.isDesktop||d.addClass("touchControl");d.css("background-image","url("+c+")");buttonCallbacks[a]=b;newButton(a,d);d.insertBefore($("#rightControls"))},createButtonNoIcon=
function(a,b){var c=$('\x3ca type\x3d"button" class\x3d"control" tabindex\x3d"-1" id\x3d"'+a+'"\x3e\x3c/a\x3e');yudu_commonSettings.isDesktop||c.addClass("touchControl");buttonCallbacks[a]=b;newButton(a,c);c.insertBefore($("#rightControls"))},newButton=function(a,b){buttons[a]=b;visibleButtons[a]||(visibleButtons.__yudu_count+=1);visibleButtons[a]=b},hideButton=function(a){buttons[a]&&(buttons[a].hide(),visibleButtons[a]&&(delete visibleButtons[a],--visibleButtons.__yudu_count))},showButton=function(a){buttons[a]&&
(buttons[a].show(),visibleButtons[a]||(visibleButtons[a]=buttons[a],visibleButtons.__yudu_count+=1))},getIconFor=function(a,b){"undefined"==typeof b&&(b=yudu_toolbarSettings.shouldUseHighRes);return yudu_toolbarSettings.toolbarIconBasePath+(b?yudu_toolbarSettings.iconHighResPrefix:"")+a+yudu_toolbarSettings.iconFileExtension},addButtonListener=function(){yudu_commonFunctions.createHammerJSTapManager(controls[0]).on("tap",handleButtonPress)},handleButtonPress=function(a){(a=a.target)&&a.id&&(a=buttonCallbacks[a.id],
"function"==typeof a&&a())},positionButtonsForTouch=function(){if(0!=visibleButtons.__yudu_count){var a=controls.width()/visibleButtons.__yudu_count,b=!1,c=0,d;for(d in buttons)visibleButtons.hasOwnProperty(d)&&(!1===b&&(b=a/2-visibleButtons[d].outerWidth(!0)/2),visibleButtons[d].css({left:b+a*c}),c++)}},fullscreenUI,initFullscreen=function(a){createButtonNoIcon("fullscreen",toggleFullscreen);fullscreenUI={button:$("#fullscreen"),iconEnter:"url("+getIconFor("fullscreen-enter",a)+")",iconExit:"url("+
getIconFor("fullscreen-exit",a)+")"};fullscreenUI.button.css("background-image",fullscreenUI.iconEnter);document.addEventListener("fullscreenchange",prepareFullscreenIcon);document.addEventListener("msfullscreenchange",prepareFullscreenIcon);document.addEventListener("mozfullscreenchange",prepareFullscreenIcon);document.addEventListener("webkitfullscreenchange",prepareFullscreenIcon)},isFullscreen=function(){return document.fullscreenElement||document.msFullscreenElement||document.mozFullScreenElement||
document.webkitFullscreenElement},toggleFullscreen=function(){isFullscreen()?yudu_toolbarFunctions.exitFullscreen():yudu_toolbarFunctions.goFullscreen();prepareFullscreenIcon()},prepareFullscreenIcon=function(){isFullscreen()?fullscreenUI.button.css("background-image",fullscreenUI.iconExit):fullscreenUI.button.css("background-image",fullscreenUI.iconEnter)},sharingShowing=!1,sharingUI={},shareCurrentPage=!1,initSharing=function(){sharingUI={shareButton:$("#share"),dropdown:{container:$("#shareContainer"),
currentPage:$("#currentPage"),firstPage:$("#firstPage")}};var a={};sharingUI.dropdown.container.addClass(yudu_commonSettings.isDesktop?"isDesktop":"touchDevice");yudu_commonFunctions.createHammerJSTapManager(sharingUI.dropdown.container[0]).on("tap",function(b){var c=b.target.id;if(c&&a[c]&&"function"==typeof a[c])a[c](b)});$(".noDrag").on("touchmove",function(){return!1});if(yudu_toolbarSettings.sharing.emailEnabled||yudu_toolbarSettings.sharing.twitter||yudu_toolbarSettings.sharing.facebook)a.currentPage=
function(){toggleSharingPage(!0)},a.firstPage=function(){toggleSharingPage(!1)};var b=function(b,e,h){var f=document.getElementById(b),g=document.createElement("img");g.classList.add("noPointerEvents");g.src=e;f.insertBefore(g,f.firstChild);f.style.display="block";a[b]=c(h)},c=function(a){return function(b){hideSharing();"function"==typeof a&&a(b);yudu_commonFunctions.hideToolbar()}};yudu_toolbarSettings.sharing.emailEnabled&&b("email",yudu_toolbarSettings.toolbarIconBasePath+"email.png",yudu_sharingFunctions.shareEmail);
yudu_toolbarSettings.sharing.twitter&&b("twitter",yudu_sharingSettings.twitterIconPath,yudu_sharingFunctions.shareTwitter);yudu_toolbarSettings.sharing.facebook&&b("facebook",yudu_sharingSettings.facebookIconPath,yudu_sharingFunctions.shareFacebook);setSharingLeftPosition()},toggleSharingPage=function(a){a!=shareCurrentPage&&(shareCurrentPage=a,yudu_sharingFunctions.togglePage(a),sharingUI.dropdown.currentPage.toggleClass("selected"),sharingUI.dropdown.firstPage.toggleClass("selected"))},toggleShareAction=
function(){toggleSharing(!0)?(yudu_toolbarFunctions.setAutoHide(!1),toggleContents(!1,!1),toggleUserPreferences(!1,!1),yudu_thumbnailsFunctions.toggleThumbnails(!1,!1)):yudu_toolbarFunctions.setAutoHide(!0)},toggleSharing=function(a,b){var c=a?!sharingShowing:b;if(c==sharingShowing)return sharingShowing;c?sharingUI.dropdown.container.show():sharingUI.dropdown.container.hide();sharingShowing=c;setSharingLeftPosition();return sharingShowing},setSharingLeftPosition=function(){if(sharingShowing){var a=
sharingUI.shareButton.offset().left,a=Math.min(a,yudu_commonSettings.width/yudu_commonSettings.pixelDensity-sharingUI.dropdown.container.width()-10);sharingUI.dropdown.container.css({left:a,width:sharingUI.dropdown.container.width()})}},hideSharing=function(){sharingShowing&&toggleSharing(!1,!1)},contentsShowing=!1,contentsUI={},contentsCallbacks={},initContents=function(){if(yudu_contentsSettings.contentsData&&0!=yudu_contentsSettings.contentsData.length){contentsUI={contentsButton:$("#contents"),
dropdown:{container:$("#contentsContainer"),list:$("#contentsList")}};yudu_commonFunctions.createHammerJSTapManager(contentsUI.dropdown.list[0]).on("tap",function(a){if(a.target.classList.contains("contentsLink")){var b=a.target.dataset.id,b=b&&contentsCallbacks[b];"function"==typeof b&&b(a)}});for(var a=0,b=yudu_contentsSettings.contentsData.length;a<b;a++)contentsUI.dropdown.list.append(renderContentsElement(yudu_contentsSettings.contentsData[a]));contentsUI.dropdown.list.find("hr").last().remove();
yudu_commonSettings.isDesktop?contentsUI.dropdown.container.addClass("isDesktop"):(contentsUI.dropdown.container.addClass("touchDevice"),yudu_commonFunctions.enableScrollingWithoutDocumentBouncing(contentsUI.dropdown.container));setContentsLeftPosition()}},renderContentsElement=function(a){var b=generateContentsId(),c=$("\x3cdiv\x3e\x3c/div\x3e");c.addClass("contentsElement");var d=$("\x3cdiv\x3e\x3c/div\x3e");d.addClass("contentsLink");d.html(a.description);d.attr("data-id",b);var e=$("\x3chr\x3e");
contentsCallbacks[b]=function(){yudu_commonFunctions.goToPage(a.page);hideContents();yudu_commonFunctions.hideToolbar()};c.append(d);c.append(e);if(a.children)for(b=0,d=a.children.length;b<d;b++)c.append(renderContentsElement(a.children[b]));return c},generateContentsId=function(){var a=0;return function(){return"contentsItem"+a++}}(),toggleContentsAction=function(){toggleContents(!0)?(yudu_toolbarFunctions.setAutoHide(!1),yudu_thumbnailsFunctions.toggleThumbnails(!1,!1),toggleSharing(!1,!1),toggleUserPreferences(!1,
!1)):yudu_toolbarFunctions.setAutoHide(!0)},toggleContents=function(a,b){var c=a?!contentsShowing:b;if(c==contentsShowing)return contentsShowing;c?contentsUI.dropdown.container.show():contentsUI.dropdown.container.hide();contentsShowing=c;setContentsLeftPosition();return contentsShowing},setContentsLeftPosition=function(){if(contentsShowing){var a=contentsUI.contentsButton.offset().left,a=Math.min(a,yudu_commonSettings.width/yudu_commonSettings.pixelDensity-contentsUI.dropdown.container.width()-10);
contentsUI.dropdown.container.css({left:a})}},hideContents=function(){contentsShowing&&toggleContents(!1,!1)},userPreferencesShowing=!1,userPreferencesUI={},initUserPreferences=function(){userPreferencesUI={userPreferencesButton:$("#userPreferences"),dialog:{container:$("#yudu_userPreferences"),checkboxes:$("#yudu_userPreferences input")}};userPreferencesUI.dialog.checkboxes.change(function(a){var b=$(a.target);a=b.parent().attr("data-setting-name");b=b.is(":checked");a&&window.yudu_commonFunctions.updateUserPreferenceSetting&&
window.yudu_commonFunctions.updateUserPreferenceSetting(a,b)});setUserPreferencesLeftPosition()},enableUserPreferencesSettings=function(){var a=!1,b;for(b in yudu_toolbarSettings.userPreferences)if(yudu_toolbarSettings.userPreferences.hasOwnProperty(b)){var c=yudu_toolbarSettings.userPreferences[b];if(c.show){var d=$("#yudu_userPreferences").children("div[data-setting-name\x3d"+b+"]");d.show();c["default"]&&d.find("input[type\x3d'checkbox']").prop("checked",!0);a=a||0<d.length}}return a},toggleUserPreferencesAction=
function(){toggleUserPreferences(!0)?(yudu_toolbarFunctions.setAutoHide(!1),toggleSharing(!1,!1),toggleContents(!1,!1),yudu_thumbnailsFunctions.toggleThumbnails(!1,!1)):yudu_toolbarFunctions.setAutoHide(!0)},toggleUserPreferences=function(a,b){var c=a?!userPreferencesShowing:b;if(c==userPreferencesShowing)return userPreferencesShowing;c?userPreferencesUI.dialog.container.show():userPreferencesUI.dialog.container.hide();userPreferencesShowing=c;setUserPreferencesLeftPosition();return userPreferencesShowing},
setUserPreferencesLeftPosition=function(){if(userPreferencesShowing){var a=userPreferencesUI.userPreferencesButton.offset().left,a=Math.min(a,yudu_commonSettings.width/yudu_commonSettings.pixelDensity-userPreferencesUI.dialog.container.width()-10);userPreferencesUI.dialog.container.css({left:a})}},hideUserPreferences=function(){userPreferencesShowing&&toggleUserPreferences()},toggleThumbnailsAction=function(){yudu_thumbnailsFunctions.toggleThumbnails(!0);toggleSharing(!1,!1);toggleContents(!1,!1);
toggleUserPreferences(!1,!1)},hideThumbnails=function(){yudu_thumbnailsFunctions.toggleThumbnails(!1,!1)},toggleDrawingModeAction=function(){yudu_drawingToolbarFunctions.setHighlightingMode(!0);toggleSharing(!1,!1);toggleContents(!1,!1);toggleUserPreferences(!1,!1);hideThumbnails()},searchSetup=function(){setSearchComponents();positionSearchResults()},positionSearchResults=function(){yudu_commonSettings.isDesktop&&yudu_searchFunctions.positionDesktopSearchResults({top:"34px",left:"auto",bottom:"auto",
right:"0px"},{topLeft:"0px",topRight:"0px",bottomRight:"5px",bottomLeft:"5px"})},setSearchComponents=function(){yudu_commonSettings.isDesktop&&yudu_searchFunctions.setBrandableSearchComponents($("#desktopSearchText"),$("#desktopSearchGo"))},onResize=function(){yudu_commonSettings.isDesktop||positionButtonsForTouch();setTogglableLeftPosition();positionSearchResults()},onLoginApproved=function(){yudu_toolbarFunctions.articlesAvailable()&&(showButton("phoneview"),yudu_commonSettings.isDesktop||positionButtonsForTouch(),
yudu_events.unsubscribe(yudu_events.ALL,yudu_events.COMMON.LOGIN_APPROVED,onLoginApproved,!1))},setTogglableLeftPosition=function(){setSharingLeftPosition();setContentsLeftPosition();setUserPreferencesLeftPosition()},hideTogglables=function(){hideSharing();hideContents();hideUserPreferences();hideThumbnails()},buttonOtherThanTogglableHit=function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){hideTogglables();return b.apply(a,c)}},cssFiles=[yudu_commonFunctions.createBrandingPath("toolbar/style.css")];
yudu_commonFunctions.loadCss(cssFiles,toolbarInit);