var timer;self.addEventListener("message",function(e){switch(e.data.cmd){case"fetch":fetch(e.data.url,e.data.id,e.data.priority,e.data.headers);break;case"start":start(e.data.pps,e.data.batchSize);break;case"clear":clearQueues();break;case"stop":stop()}},!1);var priorityQueue=[],queue=[],liveRequests={},batchSize=20,active=0,urlObj=self.URL||self.webkitURL,makeBlobs="undefined"!=typeof Blob;function fetch(e,t,s,a){var r={url:e,id:t,headers:a};s?priorityQueue.push(r):queue.push(r)}function processQueue(){if(!(batchSize<active)){var e=batchSize-active,t=priorityQueue.splice(0,e);e=Math.max(0,e-t.length);for(var s=t.concat(queue.splice(0,e)),a=0;a<s.length;a++)this.getImage(s[a].url,Date.now(),s[a].id,s[a].headers);active+=s.length}}function getImage(e,t,s,a){var r=new XMLHttpRequest;for(var i in r.onreadystatechange=function(){if(liveRequests[s]&&4==this.readyState)if(delete liveRequests[s],active--,200==this.status)if(urlObj&&urlObj.createObjectURL&&makeBlobs){var e=urlObj.createObjectURL(new Blob([this.response],{type:"image/jpeg"}));self.postMessage({cmd:"fetched",url:e,startTime:t,id:s})}else self.postMessage({cmd:"fetchedCreate",response:this.response,startTime:t,id:s});else self.postMessage({cmd:"fetchFail",id:s,code:this.status})},(liveRequests[s]=r).open("GET",e),r.responseType="arraybuffer",a)a.hasOwnProperty(i)&&r.setRequestHeader(i,a[i]);r.send()}function log(e){self.postMessage({cmd:"log",log:e})}function start(e,t){batchSize=t,timer=setInterval(processQueue,1e3/e)}function stop(){clearInterval(timer),self.close()}function clearQueues(){for(var e in priorityQueue=[],queue=[],liveRequests)liveRequests.hasOwnProperty(e)&&liveRequests[e].abort();liveRequests={},active=0}